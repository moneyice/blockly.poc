<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Blockly Generator Tests</title>
  <script src="../../blockly_uncompressed.js"></script>

  <!-- Home_Unit_test -->
  <script src='./getMyData.js'></script>
  <script src="../../generators/aviator.js"></script>
  <script src="../../generators/aviator/logic.js"></script>
  <script src="../../generators/aviator/math.js"></script>
  <script src="../../generators/aviator/text.js"></script>
  <script src="../../generators/aviator/variables.js"></script>
  <script src="../../generators/aviator/procedures.js"></script>
  <script src="../../generators/aviator/my.js"></script>
  <script src="./jquery-3.4.1.js"></script>
  <script src="./zh-hans.js"></script>

  <script src="../../msg/messages.js"></script>
  <script src="../../blocks/logic.js"></script>
  <script src="../../blocks/math.js"></script>
  <script src="../../blocks/text.js"></script>
  <script src="../../blocks/variables.js"></script>
  <script src="../../blocks/procedures.js"></script>
  <script>
    'use strict';
    var demoWorkspace = null;
    var outputCode = '';
    let URI = 'http://localhost:8080/';
    function start() {
      demoWorkspace = Blockly.inject('blocklyDiv',
        {
          grid:
          {
            spacing: 25,
            length: 3,
            colour: '#ccc',
            snap: true
          },
          media: '../../media/',
          toolbox: document.getElementById('toolbox'),
          zoom: { controls: true, wheel: true }
        });
      // changeIndex();
      // for (var messageKey in MSG) {
      //   if (messageKey.indexOf('cat') == 0) {
      //     Blockly.Msg[messageKey.toUpperCase()] = MSG[messageKey];
      //   }
      // }
      var workspace = Blockly.getMainWorkspace();
      //-------------------------声明参数传入-----------------------
      var newVar = getVariablesData();
      var isClick = false;
      $('#blockly-5').click(() => {
        if (isClick) { } else {
          isClick = true;
          Blockly.Variables.createVariableButtonHandlerMY(workspace, newVar);
        }
      })

      demoWorkspace.myFlyoutCallback = function (workspace) {
        // Returns an array of hex colours, e.g. ['#4286f4', '#ef0447']
        var funcData = getFuncData();
        var xmlList = [];
        for (let index = 0; index < funcData.length; index++) {
          if (funcData[index][0] == 'myfunction') {
            var blockText = '<block type="my_function">' +
              '<field name="NAME">' + funcData[index][2] + '</field>' +
              '</block>';
            var block = Blockly.Xml.textToDom(blockText);
            xmlList.push(block);

          } else if (funcData[index][0] == 'myfunction_2') {
            var blockText = '<block type="my_function_2">' +
              '<field name="NAME">' + funcData[index][2] + '</field>' +
              '</block>';
            var block = Blockly.Xml.textToDom(blockText);
            xmlList.push(block);

          }

        }
        // if (Blockly.Blocks['my_function']) {
        //   for (var i = 0; i < colourList.length; i++) {
        //     var blockText = '<block type="my_function">' +
        //       '<field name="NAME">' + colourList[i][1] + '</field>' +
        //       '</block>';
        //     var block = Blockly.Xml.textToDom(blockText);
        //     xmlList.push(block);
        //   }
        // } else if (Blockly.Blocks['my_functionv']) {
        //   var blockText = '<block type="my_functionv">' +
        //     '<field name="NAME">' + 'rate' + '</field>' +
        //     '</block>';
        //   var block = Blockly.Xml.textToDom(blockText);
        //   xmlList.push(block);
        // }
        return xmlList;
      };
      workspace.registerToolboxCategoryCallback(
        'MY', demoWorkspace.myFlyoutCallback);
    }
    ////设置my 自定义块
    Blockly.Blocks['my_return'] = {
      init: function () {
        this.appendValueInput('VALUE')
          .setCheck('Number')
          .appendField('返回', 'NAME');
        this.setPreviousStatement(true, 'Number');
        // this.setOutput(true, 'Number');
        this.setColour(210);
        this.setTooltip('返回');
        this.setHelpUrl('return');
      }
    };
    //my-function   .appendField('getHome');
    Blockly.Blocks['my_function'] = {
      init: function () {
        this.appendDummyInput()
          .setAlign(Blockly.ALIGN_RIGHT)
          .appendField(new Blockly.FieldLabelSerializable(''), 'NAME');
        this.setOutput(true, 'Number');
        this.setColour(130);
        this.setTooltip('函数');
        this.setHelpUrl('');
      }
    }
    //带两个参数的函数  块样式配置
    Blockly.Blocks['my_function_2'] = {
      init: function () {
        this.appendValueInput("NAME")
          .setCheck(null)
          .appendField(new Blockly.FieldLabelSerializable("计算个人所得税"), "NAME");
        this.appendDummyInput();
        this.setOutput(true, null);
        this.setColour(130);
        this.setTooltip("");
        this.setHelpUrl("calculateTax");
      }
    };

    /**
     * Run this test to load all of the tests in the selected suites.  The contents
     * will be loaded into the workspace in order.  To test the generators:
     * - select your language from the buttons above the text area
     * - copy all of the generated code
     * - run it in an interpreter of your choice
     * - scan all of the results for "FAIL".  All test suites are running in order,
     *      and each will report OK or FAIL based only on the tests in that suite.
     * If some tests are failing, load test suites individually to continue
     * debugging.
     */
    function loadSelected() {
      var output = document.getElementById('importExport');
      output.style.background = 'gray';

      var loadingElem = document.getElementById('loading');
      loadingElem.textContent = 'loading...';

      // Clear before adding all of the blocks.
      demoWorkspace.clear();

      var boxList = document.getElementsByClassName('suite_checkbox');
      for (var i = 0; i < boxList.length; i++) {
        if (boxList[i].checked) {
          var testUrl = boxList[i].value;
          if (testUrl) {
            var xmlText = fetchFile(testUrl);
            if (xmlText !== null) {
              fromXml(testUrl, xmlText, /* opt_append */ true);
            }
          }
        }
      }
      output.style.background = '';
      loadingElem.textContent = 'done';
    }

    /**
     * Ask the user for a file name, then load that file's contents.
     */
    function loadOther() {
      var url = window.prompt('Enter URL of test file.');
      if (!url) {
        return;
      }
      var xmlText = fetchFile(url);
      if (xmlText !== null) {
        fromXml(url, xmlText);
      }
    }

    function fetchFile(xmlUrl) {
      try {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open('GET', xmlUrl, false);
        xmlHttp.setRequestHeader('Content-Type', 'text/xml');
        xmlHttp.send('');
      } catch (e) {
        // Attempt to diagnose the problem.
        var msg = 'Error: Unable to load XML data.\n';
        if (window.location.protocol == 'file:') {
          msg += 'This may be due to a security restriction preventing\n' +
            'access when using the file:// protocol.\n' +
            'Use an http webserver, or a less paranoid browser.\n';
        }
        alert(msg + '\n' + e);
        return null;
      }
      return xmlHttp.responseText;
    }

    /**
     * @param {string} filename The URL (or other name) of the XML, for reporting.
     * @param {string} xmlText The actual XML text.
     * @param {boolean=} opt_append True if the XML should be appended to the
     *     workspace.  Otherwise the workspace is cleared and the new XML is loaded.
     */
    function fromXml(filename, xmlText, opt_append) {
      var output = document.getElementById('importExport');
      output.value = xmlText;
      output.scrollTop = 0;
      output.scrollLeft = 0;
      if (!opt_append) {
        demoWorkspace.clear();
      }
      try {
        var xmlDoc = Blockly.Xml.textToDom(xmlText);
        if (opt_append) {
          Blockly.Xml.appendDomToWorkspace(xmlDoc, demoWorkspace);
        } else {
          Blockly.Xml.domToWorkspace(xmlDoc, demoWorkspace);
        }
      } catch (e) {
        var msg = 'Error parsing XML: ' + filename + '\n\n\t' + e;
        if (e.stack) {
          msg += '\n\nSee console for stack trace details.'
        }
        console.error(e.stack ? e : msg);
        alert(msg);
        return;
      }
    }

    function setOutput(text) {
      var output = document.getElementById('importExport');
      output.value = text;
      output.focus();
      // output.select();
    }

    function toXml() {
      var xmlDom = Blockly.Xml.workspaceToDom(demoWorkspace,
    /* opt_noId */ true);
      var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
      console.log(xmlText);
      xmlText = xmlText.replace(/ id="\d+"/g, '');

      setOutput(xmlText);
    }
    function toAviator() {
      //js启用严格模式  
      // var code = '\'use strict\';\n\n'
      var code = '';
      code += Blockly.Aviator.workspaceToCode(demoWorkspace);
      setOutput(code);
      outputCode = code;
    }


    function Save() {
      var fileName = document.getElementById('fileName').value
      if (fileName == '') {
        window.alert('请输入名称')
        return
      }
      SaveXML(fileName)
      SaveScript(fileName);
    }
    function SaveXML(fileName) {
      var xmlDom = Blockly.Xml.workspaceToDom(demoWorkspace,
    /* opt_noId */ true);
      var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
      // xmlText = xmlText.replace(/ id="\d+"/g, '');
      // console.log(xmlText);
      var url = URI + 'saveXML/' + fileName;
      $.ajax({
        url: url,
        type: 'post',
        data: xmlText,
        dataType: 'text',
        success: function (data) {
          console.log('XML保存成功', data);
        },
        error: function (error) {
          console.log(error);
        }

      })
    }
    function SaveScript(fileName) {
      var code = '';
      code += Blockly.Aviator.workspaceToCode(demoWorkspace);
      var url = URI + 'saveScript/' + fileName;
      $.ajax({
        url: url,
        type: 'post',
        data: code,
        dataType: 'text',
        success: function (data) {

          console.log('CODE保存成功', data);

        },
        error: function (error) {
          console.log(error)
        }
      })

    }
    function LoadXml() {
      var fileName = document.getElementById('fileName').value
      var url = URI + 'loadXML/' + fileName;
      $.ajax({
        url: url,
        type: 'post',
        data: fileName,
        dataType: 'text',
        success: function (data) {
          fromXml('', data)
        },
        error: function (error) {
          console.log(error)
        }

      })
    }
    function Run() {
      var fileName = document.getElementById('fileName').value;
      var url = URI + 'executeRule/' + fileName;
      $.ajax({
        url: url,
        type: 'post',
        data: fileName,
        dataType: 'text',
        success: function (data) {
          document.getElementById('executeRule').value = data;
        },
        error: function (error) {
          console.log(error)
        }
      })
    }
  </script>

  <style>
    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background-color: #fff;
      font-family: sans-serif;
      margin: 0 5px;
    }

    h1 {
      font-weight: normal;
      font-size: 140%;
    }

    #blocklyDiv {
      float: right;
      height: 95%;
      width: 69%;
      margin-top: 5px;
    }

    #importExport {
      height: 100%;
      width: 100%;
    }

    #loading {
      color: red;
    }
  </style>
</head>

<body onload="start()">
  <div id="blocklyDiv">
  </div>
  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="%{BKY_CATLOGIC}" colour="210">
      <block type="controls_if"></block>
      <block type="controls_ifelse"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
      <block type="my_return"></block>
    </category>
    <category name="%{BKY_CATMATH}" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
    </category>
    <category name="%{BKY_CATTEXT}" colour="160">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append"></block>
      <block type="text_length"></block>
      <block type="text_isEmpty"></block>
      <block type="text_indexOf"></block>
      <block type="text_charAt"></block>
      <block type="text_getSubstring"></block>
      <block type="text_changeCase"></block>
      <block type="text_trim"></block>
      <block type="text_print"></block>
      <block type="text_prompt_ext"></block>
      <block type="text_count"></block>
      <block type="text_replace"></block>
      <block type="text_reverse"></block>
    </category>
    <sep></sep>
    <category name="%{BKY_CATVARIABLES}" colour="330" custom="VARIABLE"></category>
    <category name="%{BKY_CATFUNCTIONS}" colour="290" custom="PROCEDURE"></category>
    <category name="%{BKY_CATMY}" colour="230" custom="MY">
    </category>
  </xml>
  <table height="95%" width="30%">
    <tr>
      <td valign="top">
        <p>
          <span>名称: </span>
          <input type="text" id="fileName">
          <input type="button" value="Save" onclick="Save()">
        </p>
        <p>
          Generate:
          <input type="button" value="XML" onclick="toXml()">
          <input type="button" value="LoadXml" onclick="LoadXml()">
        </p>
        <div style="display: inline-block;">
          <input type="button" value="Aviator" onclick="toAviator()">
        </div>
        <p></p>
      </td>
    </tr>
    <tr>
      <td height="50%">
        <textarea id="importExport" wrap="on"></textarea>
      </td>
    </tr>
    <tr>
      <td>
        <input type="button" value="执行" onclick="Run()">
      </td>
    </tr>
    <tr>
      <td height="20%">
        <textarea id="executeRule" wrap="off" style="height: 100%;width: 100%;"></textarea>
      </td>
    </tr>
  </table>
</body>

</html>